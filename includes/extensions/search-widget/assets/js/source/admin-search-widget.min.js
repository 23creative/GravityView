/**
 * New Search widget UI at Add New / Edit Views screen
 *
 * @package   GravityView
 * @license   GPL2+
 * @author    Katz Web Services, Inc.
 * @link      http://gravityview.co
 * @copyright Copyright 2014, Katz Web Services, Inc.
 *
 * @since 1.1.7
 */
!function($){var e={selectFields:null,init:function(){var a=e;$("body").on("dialogopen",'[data-fieldid="search_bar"] .gv-dialog-options',a.openDialog).on("click",".gv-dialog-options a[href='#addSearchField']",a.addField).on("click",".gv-dialog-options a[href='#removeSearchField']",a.removeField).on("change",".gv-dialog-options select.gv-search-fields",a.updateRow).on("sortcreate sortupdate sort",".gv-dialog-options table",a.zebraStripe).on("dialogbeforeclose",'[data-fieldid="search_bar"] .gv-dialog-options',a.updateOnClose),$("#gravityview_form_id, #gravityview_directory_template").change(a.clearCache)},openDialog:function(a){a.preventDefault(),e.renderUI($(this).parents(".gv-fields"))},addField:function(a){a.preventDefault();var t=$(this).parents("table"),l=$(this).parents("tr");return l.hasClass("no-search-fields")&&(l.remove(),l=null),t.find("tr.no-search-fields").remove(),e.addRow(t,l,null),!1},removeField:function(a){a.preventDefault();var t=$(this).parents("table");return $(this).parents("tr").fadeTo("normal",.4,function(){$(this).remove(),$("tr.gv-search-field-row",t).length<1&&$("tr.no-search-fields",t).length<1?e.addEmptyMsg(t):e.zebraStripe(t)}),!1},renderUI:function(a){var t=e,l=$(".gv-search-fields-value",a).val(),n=$(".gv-dialog-options",a);return null===t.selectFields?(n.append('<p id="gv-loading"><span class="spinner"></span>'+gvGlobals.loading_text+"</p>"),void t.getSelectFields(a)):void($("table",n).length&&$("#gv-loading").length<1||(table=t.addTable(),0===l.length?t.addRow(table,null,null):t.populateRows(table,l),n.append(table),n.find("table tbody").sortable({start:function(e,a){$(a.item).removeClass("alt")}}),$("#gv-loading").remove()))},zebraStripe:function(e){var a=e.target||e;$(a).find("tr.gv-search-field-row").removeClass("alt").filter(":even").addClass("alt")},populateRows:function(a,t){var l=$.parseJSON(t),n=null;$.each(l,function(t,l){e.addRow(a,n,l),n=a.find("tbody tr:last")})},addTable:function(){return $('<table class="form-table widefat"><thead><tr><th class="cell-sort">&nbsp;</th><th class="cell-search-fields">'+gvSearchVar.label_searchfield+'</th><th class="cell-input-types">'+gvSearchVar.label_inputtype+'</th><th class="cell-add-remove">&nbsp;</th></tr></thead><tbody></tbody></table>')},addEmptyMsg:function(e){$(e).append('<tr class="no-search-fields"><td colspan="4">'+gvSearchVar.label_nofields+'&nbsp; <a href="#addSearchField">'+gvSearchVar.label_addfield+"</a></td></tr>")},addRow:function(a,t,l){var n=$('<tr class="gv-search-field-row new-row hide-if-js" />').append('<td class="cell-sort"><span class="icon gv-icon-caret-up-down" /></td>').append('<td class="cell-search-fields">'+e.selectFields+"</td>").append('<td class="cell-input-types"><select class="gv-search-inputs" /></td>').append('<td class="cell-add-remove"><a href="#addSearchField" class="dashicons dashicons-plus-alt" /><a href="#removeSearchField" class="dashicons dashicons-dismiss" /></td>');null!==t&&t.length?$(t,a).after(n):$("tbody",a).append(n),a.find("tr.new-row").each(function(){$(this).removeClass("new-row"),null!==l&&$(this).find("select.gv-search-fields").val(l.field),e.updateSelectInput($(this)),null!==l&&$(this).find("select.gv-search-inputs").val(l.input),$(this).fadeTo("normal",1,function(){$(this).removeClass("hide-if-js")})}),e.zebraStripe(a)},updateRow:function(){var a=$(this).parents("tr");e.updateSelectInput(a)},updateSelectInput:function(a){var t=a.find("select.gv-search-fields option:selected").attr("data-inputtypes"),l=a.find("select.gv-search-inputs"),n=e.getSelectInput(t);l.html(n),l.find("option").length<2?l.prop("disabled",!0):l.prop("disabled",!1)},getSelectFields:function(a){$.ajax({url:ajaxurl,type:"POST",async:!0,dataType:"html",data:{action:"gv_searchable_fields",nonce:gvSearchVar.nonce,formid:$("#gravityview_form_id").val(),template_id:$("#gravityview_directory_template").val()},success:function(t){"0"!==t&&(e.selectFields=t,e.renderUI(a))}})},getSelectInput:function(a){var t=$.parseJSON(gvSearchVar.input_labels),l=$.parseJSON(gvSearchVar.input_types),n="",s=e.getValue(l,a);return null===s?"":($.each(s,function(a,l){var s=e.getValue(t,l);n+='<option value="'+l+'">'+s+"</option>"}),n)},getValue:function(e,a){var t=null;return $.each(e,function(e,l){return a===e?(t=l,!1):void 0}),t},updateOnClose:function(e,a){var t=$(this),l=[];t.find("table tr.gv-search-field-row").each(function(){var e={};e.field=$(this).find("select.gv-search-fields").val(),e.input=$(this).find("select.gv-search-inputs").val(),l.push(e)}),$(".gv-search-fields-value",t).val(JSON.stringify(l))},clearCache:function(){e.selectFields=null,$(".gv-search-fields-value").each(function(){$(this).parents(".gv-dialog-options").find("table").remove(),$(this).val("")})}};$(document).ready(function(){e.init()})}(jQuery);