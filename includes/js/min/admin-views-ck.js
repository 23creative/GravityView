/**
 * Custom js script at Add New / Edit Views screen
 *
 * @package   GravityView
 * @author    Zack Katz <zack@katzwebservices.com>
 * @license   ToBeDefined
 * @link      http://www.katzwebservices.com
 * @copyright Copyright 2013, Katz Web Services, Inc.
 *
 * @since 1.0.0
 */
!function(e){var t={startFreshStatus:!1,init:function(){var i=t;i.gvStartFreshButton=e('a[href="#gv_start_fresh"]'),i.gvSelectForm=e("#gravityview_form_id"),i.currentFormId=i.gvSelectForm.val(),""===i.currentFormId?i.hideView():e("#gravityview_directory_template").val().length>0?(e("#gravityview_select_template").slideUp(150),i.showViewConfig()):(i.templateFilter("custom"),i.showTemplates()),i.gvStartFreshButton.click(i.startFresh),i.gvSelectForm.change(i.formChange),e('a[href="#gv_select_template"]').click(i.selectTemplate),e(".gv-view-types-hover").click(i.selectTemplateHover),e('a[href="#gv_preview_template"]').click(i.previewTemplate),e(document).mouseup(function(t){var i=e("a.gv-add-field[data-tooltip='active']");i.is(t.target)||0!==i.has(t.target).length||(i.tooltip("close"),i.attr("data-tooltip",""))}),e(document).on("click","#publish",i.createPresetForm)},hideView:function(){var i=t;i.currentFormId="",e("#gravityview_view_config, #gravityview_select_template").slideUp(150)},showTemplates:function(){e("#gravityview_select_template").slideDown(150)},startFresh:function(e){e.preventDefault();var i=t;i.startFreshStatus=!0,""!==i.currentFormId?i.showDialog():i.startFreshContinue()},startFreshContinue:function(){var i=t;e("#gravityview_form_id_start_fresh").val("1"),i.templateFilter("preset"),i.showTemplates(),e("#gravityview_view_config").slideUp(150)},formChange:function(){var i=t;i.startFreshStatus=!1,""!==i.currentFormId&&i.currentFormId!==e(this).val()?i.showDialog():i.formChangeContinue()},formChangeContinue:function(){var e=t;""===e.gvSelectForm.val()?e.hideView():(e.templateFilter("custom"),e.showTemplates(),e.getAvailableFields())},showDialog:function(){var i=t,a=e("#gravityview_form_id_dialog");a.dialog({dialogClass:"wp-dialog",appendTo:a.parent(),closeOnEscape:!0,buttons:[{text:gvGlobals.label_cancel,click:function(){i.startFreshStatus=!1,i.gvSelectForm.val(i.currentFormId),a.dialog("close")}},{text:gvGlobals.label_continue,click:function(){i.startFreshStatus?i.startFreshContinue():i.formChangeContinue(),a.dialog("close")}}]})},templateFilter:function(t){e(".gv-view-types-module").each(function(){e(this).attr("data-filter")===t?e(this).parent().show():e(this).parent().hide()})},selectTemplate:function(i){var a=t;i.preventDefault(),i.stopImmediatePropagation();var o=e(this).attr("data-templateid");e("#gravityview_directory_template").val(o);var l=e(this).parents(".gv-view-types-module");l.parents(".gv-grid").find(".gv-view-types-module").removeClass("gv-selected"),l.addClass("gv-selected"),a.startFreshStatus?(a.getAvailableFields("preset",o),a.getPresetFields(o)):a.updateActiveAreas(o)},selectTemplateHover:function(t){t.preventDefault(),t.stopImmediatePropagation(),e(this).find('a[href="#gv_select_template"]').trigger("click")},previewTemplate:function(t){t.preventDefault(),t.stopImmediatePropagation();var i=e(event.currentTarget).parents(".gv-view-types-module");i.find(".gv-template-preview").dialog({dialogClass:"wp-dialog",appendTo:e("#gravityview_select_template"),width:550,closeOnEscape:!0,buttons:[{text:gvGlobals.label_close,click:function(){e(this).dialog("close")}}],close:function(){e(this).dialog("option","appendTo",i)}})},updateActiveAreas:function(i){var a=t;e("#directory-active-fields, #single-active-fields").children().remove();var o={action:"gv_get_active_areas",template_id:i,nonce:gvGlobals.nonce};e.post(gvGlobals.ajaxurl,o,function(t){if(t){var i=e.parseJSON(t);e("#directory-active-fields").append(i.directory),e("#single-active-fields").append(i.single),a.showViewConfig()}})},getPresetFields:function(i){var a=t;e("#directory-active-fields, #single-active-fields").children().remove();var o={action:"gv_get_preset_fields",template_id:i,nonce:gvGlobals.nonce};e.post(gvGlobals.ajaxurl,o,function(t){if(t){var i=e.parseJSON(t);e("#directory-active-fields").append(i.directory),e("#single-active-fields").append(i.single),a.showViewConfig()}})},showViewConfig:function(){var i=t;e("#gravityview_view_config").slideDown(150),i.toggleDropMessage(),i.init_droppables(),i.init_tooltips(),i.initFieldControls()},init_tooltips:function(){var i=t;e(".gv-add-field").tooltip({content:function(){var t=e(this).attr("data-objecttype");return"field"===t?e("#directory-available-fields").html():"widget"===t?e("#directory-available-widgets").html():void 0},disabled:!0,position:{my:"center bottom",at:"center top-12"},tooltipClass:"top"}).on("mouseout focusout",function(e){e.stopImmediatePropagation()}).click(function(t){t.preventDefault(),t.stopImmediatePropagation(),void 0!==e(this).attr("data-tooltip")&&"active"==e(this).attr("data-tooltip")?(e(this).tooltip("close"),e(this).attr("data-tooltip","")):(e(this).tooltip("open"),e(this).attr("data-tooltip","active"),e(this).attr("data-tooltip-id",e(this).attr("aria-describedby")),e(".ui-tooltip-content .gv-fields").click(i.addField)),e(this).attr("title","")})},getAvailableFields:function(i,a){var o=t;e("#directory-available-fields, #single-available-fields").find(".gv-fields").remove(),e("#directory-active-fields, #single-active-fields").find(".gv-fields").remove(),o.toggleDropMessage();var l={action:"gv_available_fields",nonce:gvGlobals.nonce};void 0!==i&&"preset"===i?l.templateid=a:l.formid=o.gvSelectForm.val(),e.post(gvGlobals.ajaxurl,l,function(t){t&&(e("#directory-available-fields").append(t),e("#single-available-fields").append(t))})},addField:function(i){i.preventDefault();var a=t,o=e(this).clone(),l=e(this).parents(".ui-tooltip").attr("id"),r=e("#gravityview_directory_template").val(),n=e(this).parents(".ui-tooltip").attr("id"),s=e('a.gv-add-field[data-tooltip-id="'+n+'"]'),d={action:"gv_field_options",template:r,area:s.attr("data-areaid"),context:s.attr("data-context"),field_id:o.attr("data-fieldid"),field_label:o.find("h5").text(),field_type:s.attr("data-objecttype"),input_type:s.attr("data-objecttype"),nonce:gvGlobals.nonce};e.post(gvGlobals.ajaxurl,d,function(e){e&&o.append(e)}),o.find("span.gv-field-controls a[href='#remove']").click(a.removeField),o.find("span.gv-field-controls a[href='#settings']").click(a.openFieldSettings),e('a[data-tooltip-id="'+l+'"]').parents(".gv-droppable-area").find(".active-drop").append(o).end().attr("data-tooltip-id",""),a.toggleDropMessage()},init_droppables:function(){var i=t;e("#directory-fields, #single-fields").find(".active-drop-widget").sortable({placeholder:"fields-placeholder",items:"> .gv-fields",distance:2,connectWith:".active-drop-widget",receive:function(t,a){var o=a.sender.attr("data-areaid"),l=e(this).attr("data-areaid");a.item.find('[name^="widgets['+o+']"]').each(function(){var t=e(this).attr("name");e(this).attr("name",t.replace(o,l))}),i.toggleDropMessage()}}),e("#directory-fields, #single-fields").find(".active-drop-field").sortable({placeholder:"fields-placeholder",items:"> .gv-fields",distance:2,connectWith:".active-drop-field",receive:function(t,a){if(a.item.find(".gv-dialog-options").length>0){var o=a.sender.attr("data-areaid"),l=e(this).attr("data-areaid");a.item.find('[name^="fields['+o+']"]').each(function(){var t=e(this).attr("name");e(this).attr("name",t.replace(o,l))})}i.toggleDropMessage()}})},toggleDropMessage:function(){e(".active-drop").each(function(){e(this).find(".gv-fields").length>0?e(this).find(".drop-message").hide():e(this).find(".drop-message").show()})},initFieldControls:function(){var i=t;e("a[href='#remove']").click(i.removeField),e("a[href='#settings']").click(i.openFieldSettings),e(".gv-fields").dblclick(i.openFieldSettings)},removeField:function(t){t.preventDefault();var i=e(event.currentTarget).parents(".active-drop");e(event.currentTarget).parents(".gv-fields").remove(),0===i.find(".gv-fields").length&&i.find(".drop-message").show()},openFieldSettings:function(t){t.preventDefault();var i;i=e(event.currentTarget).is(".gv-fields")?e(event.currentTarget):e(event.currentTarget).parents(".gv-fields"),i.find(".gv-dialog-options").dialog({dialogClass:"wp-dialog",appendTo:i,width:550,closeOnEscape:!0,buttons:[{text:gvGlobals.label_close,click:function(){e(this).dialog("close")}}]})},createPresetForm:function(){var i=t,a=e("#gravityview_directory_template").val();if(!i.startFreshStatus||""==a)return!0;var o={action:"gv_set_preset_form",template_id:a,nonce:gvGlobals.nonce};return e.post(gvGlobals.ajaxurl,o,function(t){"false"!=t?(i.startFreshStatus=!1,e("#gravityview_form_id_start_fresh").val("0"),i.gvSelectForm.find("option:selected").removeAttr("selected"),i.gvSelectForm.append(t),e("#publish").trigger("click")):e("#post").before('<div id="message" class="error below-h2"><p>'+gvGlobals.label_publisherror+"</p></div>")}),!1}};e(document).ready(function(){e("#title-prompt-text").text(gvGlobals.label_viewname),t.init(),e("#tabs").tabs({active:e("#gv-active-tab").val(),activate:function(t,i){e("#gv-active-tab").val(i.newTab.parent().children().index(i.newTab))}}),e("table.form-table tr:even").addClass("alternate")})}(jQuery);