/**
 * Custom js script at Add New / Edit Views screen
 *
 * @package   GravityView
 * @license   GPL2+
 * @author    Katz Web Services, Inc.
 * @link      http://gravityview.co
 * @copyright Copyright 2014, Katz Web Services, Inc.
 *
 * @since 1.0.0
 */
!function(e){var t={startFreshStatus:!1,init:function(){var i=t;i.gvStartFreshButton=e('a[href="#gv_start_fresh"]'),i.gvSelectForm=e("#gravityview_form_id"),i.currentFormId=i.gvSelectForm.val(),i.toggleInitialVisibility(i),i.gvStartFreshButton.click(i.startFresh),i.gvSelectForm.change(i.formChange),e('a[href="#gv_switch_view"]').click(i.switchView),e('a[href="#gv_select_template"]').click(i.selectTemplate),e(".gv-view-types-hover").click(i.selectTemplateHover),e('a[href="#gv_preview_template"]').click(i.previewTemplate),e("body").on("click",".gv-overlay",function(t){e(".ui-dialog:visible .ui-dialog-titlebar .ui-button").click()}),e("body").on("mouseup keyup",function(t){var i=!1;"keyup"===t.type&&27==t.keyCode&&(i=!0),"mouseup"===t.type&&(!e(t.target).is(".ui-tooltip")&&!e(t.target).parents(".ui-tooltip").length>0||e(t.target).parents(".close").length>0)&&(i=!0),i&&e("a.gv-add-field[data-tooltip='active']").tooltip("close")}),e("body").on("click",".ui-tooltip-content .gv-fields",function(t){e(this).has(".field-id-all-fields").length?i.addAllFields(e(this)):i.addField(e(this),t)}),e("body").on("click",".gv-shortcode input",i.selectText),e("body").on("click","span.gv-field-controls a[href='#remove']",i.removeField),e("body").on("click","span.gv-field-controls a[href='#settings']",i.openFieldSettings),e("#gravityview_view_config").find(".hndle,.handlediv").off("click").on("click",function(e){return e.preventDefault(),!1}),e("body").on("dblclick",".gv-fields",function(e){i.openFieldSettings(e)}),e(document).on("click","#publish",i.createPresetForm)},selectText:function(t){return t.preventDefault(),e(this).focus().select(),!1},toggleInitialVisibility:function(t){""===t.currentFormId?t.hideView():e("#gravityview_directory_template").val().length>0?(e("#gravityview_select_template").slideUp(150),t.showViewConfig()):(t.templateFilter("custom"),t.showTemplates())},hideView:function(){var i=t;i.currentFormId="",e("#gravityview_view_config, #gravityview_select_template").hide()},showTemplates:function(){e("#gravityview_select_template").slideDown(150)},startFresh:function(e){e.preventDefault();var i=t;i.startFreshStatus=!0,""!==i.currentFormId?i.showDialog("#gravityview_form_id_dialog"):i.startFreshContinue()},startFreshContinue:function(){var i=t;e("#gravityview_form_id_start_fresh").val("1"),i.templateFilter("preset"),i.showTemplates(),e("#gravityview_view_config").slideUp(150)},formChange:function(i){i.preventDefault();var a=t;a.startFreshStatus=!1,""!==a.currentFormId&&a.currentFormId!==e(this).val()?a.showDialog("#gravityview_form_id_dialog"):a.formChangeContinue()},formChangeContinue:function(){var i=t;""===i.gvSelectForm.val()?i.hideView():(e("body").addClass("gv-form-changed"),i.templateFilter("custom"),i.showTemplates(),i.getAvailableFields(),i.getSortableFields())},showDialog:function(i,a){var o=t,l=e(i),r=[{text:gvGlobals.label_cancel,click:function(){l.is("#gravityview_form_id_dialog")?(o.startFreshStatus=!1,o.gvSelectForm.val(o.currentFormId)):l.is("#gravityview_switch_template_dialog")&&e("#gravityview_select_template").slideUp(150),l.dialog("close")}},{text:gvGlobals.label_continue,click:function(){l.is("#gravityview_form_id_dialog")?o.startFreshStatus?o.startFreshContinue():o.formChangeContinue():l.is("#gravityview_switch_template_dialog")&&o.selectTemplateContinue(),l.dialog("close")}}];a=a||r,l.dialog({dialogClass:"wp-dialog",appendTo:l.parent(),draggable:!1,resizable:!1,width:function(){return e(window).width()>550?550:e(window).width()-10},open:function(t,i){return e('<div class="gv-overlay" />').prependTo("#wpwrap"),!0},close:function(){e("#wpwrap > .gv-overlay").fadeOut("fast",function(){e(this).remove()})},closeOnEscape:!0,buttons:a})},getSortableFields:function(i,a){var o=t;e("#gravityview_sort_field").prop("disabled","disabled").empty().append("<option>"+gvGlobals.loading_text+"</option>");var l={action:"gv_sortable_fields_form",nonce:gvGlobals.nonce};void 0!==i&&"preset"===i?l.template_id=a:l.form_id=o.gvSelectForm.val(),e.post(ajaxurl,l,function(t){"false"!==t&&e("#gravityview_sort_field").empty().append(t).prop("disabled",null)})},switchView:function(e){e.preventDefault();var i=t;i.templateFilter("custom"),i.showTemplates()},templateFilter:function(t){e(".gv-view-types-module").each(function(){e(this).attr("data-filter")===t?e(this).parent().show():e(this).parent().hide()})},selectTemplate:function(i){var a=t;i.preventDefault(),i.stopImmediatePropagation(),a.wantedTemplate=e(this);var o=e("#gravityview_directory_template").val(),l=a.wantedTemplate.attr("data-templateid");""===o?a.selectTemplateContinue():o!=l&&a.showDialog("#gravityview_switch_template_dialog")},selectTemplateContinue:function(){var i=t,a=i.wantedTemplate.attr("data-templateid");e("#gravityview_directory_template").val(a).change();var o=i.wantedTemplate.parents(".gv-view-types-module");o.parents(".gv-grid").find(".gv-view-types-module").removeClass("gv-selected"),o.addClass("gv-selected"),i.startFreshStatus?(i.getAvailableFields("preset",a),i.getPresetFields(a),i.getSortableFields("preset",a)):(i.updateActiveAreas(a),e("#gravityview_select_template").slideUp(150))},selectTemplateHover:function(t){t.preventDefault(),t.stopImmediatePropagation(),e(this).find('a[href="#gv_select_template"]').trigger("click")},previewTemplate:function(t){t.preventDefault(),t.stopImmediatePropagation();var i=e(event.currentTarget).parents(".gv-view-types-module");i.find(".gv-template-preview").dialog({dialogClass:"wp-dialog",appendTo:e("#gravityview_select_template"),width:550,open:function(){e('<div class="gv-overlay" />').prependTo("#wpwrap")},close:function(){e("#wpwrap > .gv-overlay").fadeOut("fast",function(){e(this).remove()})},closeOnEscape:!0,buttons:[{text:gvGlobals.label_close,click:function(){e(this).dialog("close")}}],close:function(){e(this).dialog("option","appendTo",i)}})},updateActiveAreas:function(i){var a=t;e("#directory-active-fields, #single-active-fields").children().remove();var o={action:"gv_get_active_areas",template_id:i,nonce:gvGlobals.nonce};e.post(ajaxurl,o,function(t){if(t){var i=e.parseJSON(t);e("#directory-header-widgets").html(i.header),e("#directory-footer-widgets").html(i.footer),e("#directory-active-fields").append(i.directory),e("#single-active-fields").append(i.single),a.showViewConfig()}})},getPresetFields:function(i){var a=t;e("#directory-active-fields, #single-active-fields").children().remove();var o={action:"gv_get_preset_fields",template_id:i,nonce:gvGlobals.nonce};e.post(ajaxurl,o,function(t){if(t){var i=e.parseJSON(t);e("#directory-header-widgets").html(i.header),e("#directory-footer-widgets").html(i.footer),e("#directory-active-fields").append(i.directory),e("#single-active-fields").append(i.single),a.showViewConfig()}})},showViewConfig:function(){var i=t;e("#gravityview_view_config").slideDown(150),i.toggleDropMessage(),i.init_droppables(),i.init_tooltips()},init_tooltips:function(){var i=t;e(".gv-add-field").tooltip({content:function(){var t=e(this).attr("data-objecttype");return"field"===t?e("#directory-available-fields").html():"widget"===t?e("#directory-available-widgets").html():void 0},close:function(t,i){e(this).attr("data-tooltip","")},open:function(t,i){e(this).attr("data-tooltip","active").attr("data-tooltip-id",e(this).attr("aria-describedby"))},closeOnEscape:!0,disabled:!0,position:{my:"center bottom",at:"center top-12"},tooltipClass:"top"}).on("mouseout focusout",function(e){e.stopImmediatePropagation()}).click(function(t){t.preventDefault(),t.stopImmediatePropagation(),e(this).tooltip("open"),e(this).attr("title","")})},getAvailableFields:function(i,a){var o=t;e("#directory-available-fields, #single-available-fields").find(".gv-fields").remove(),e("#directory-active-fields, #single-active-fields").find(".gv-fields").remove(),o.toggleDropMessage();var l={action:"gv_available_fields",nonce:gvGlobals.nonce};void 0!==i&&"preset"===i?l.template_id=a:l.form_id=o.gvSelectForm.val(),e.post(ajaxurl,l,function(t){t&&(e("#directory-available-fields").append(t),e("#single-available-fields").append(t))})},addAllFields:function(t){t.siblings(".gv-fields").each(function(){e(this).trigger("click")}),e("a.gv-add-field[data-tooltip='active']").tooltip("close")},addField:function(i,a){a.preventDefault();var o=t,l=i.clone().hide(),r=i.parents(".ui-tooltip").attr("id"),n=e("#gravityview_directory_template").val(),s=i.parents(".ui-tooltip").attr("id"),d=e('a.gv-add-field[data-tooltip-id="'+s+'"]'),c={action:"gv_field_options",template:n,area:d.attr("data-areaid"),context:d.attr("data-context"),field_id:l.attr("data-fieldid"),field_label:l.find("h5").text(),field_type:d.attr("data-objecttype"),input_type:l.attr("data-inputtype"),nonce:gvGlobals.nonce};e.post(ajaxurl,c,function(t){t&&(l.append(t),e(".all-merge-tags").remove(),"undefined"!=typeof form&&e("body").not(".gv-form-changed")&&(window.gfMergeTags=new gfMergeTagsObj(form)),e(".gv-dialog-options",l).length>0&&e(".dashicons-admin-generic",l).hide().removeClass("hide-if-js").fadeIn(100))}),e('a[data-tooltip-id="'+r+'"]').parents(".gv-droppable-area").find(".active-drop").append(l).end().attr("data-tooltip-id",""),l.fadeIn("fast"),l.siblings(".gv-fields").length>0&&(tooltipOffset=e("#"+s).offset(),e("#"+s).offset({top:tooltipOffset.top+l.outerHeight()+5})),o.toggleDropMessage()},init_droppables:function(){var i=t;e("#directory-fields, #single-fields").find(".active-drop-widget").sortable({placeholder:"fields-placeholder",items:"> .gv-fields",distance:2,revert:75,connectWith:".active-drop-widget",receive:function(t,a){var o=a.sender.attr("data-areaid"),l=e(this).attr("data-areaid");a.item.find('[name^="widgets['+o+']"]').each(function(){var t=e(this).attr("name");e(this).attr("name",t.replace(o,l))}),i.toggleDropMessage()}}),e("#directory-fields, #single-fields").find(".active-drop-field").sortable({placeholder:"fields-placeholder",items:"> .gv-fields",distance:2,revert:75,connectWith:".active-drop-field",receive:function(t,a){if(a.item.find(".gv-dialog-options").length>0){var o=a.sender.attr("data-areaid"),l=e(this).attr("data-areaid");a.item.find('[name^="fields['+o+']"]').each(function(){var t=e(this).attr("name");e(this).attr("name",t.replace(o,l))})}i.toggleDropMessage()}})},toggleDropMessage:function(){e(".active-drop").each(function(){e(this).find(".gv-fields").length>0?e(this).find(".drop-message").hide():e(this).find(".drop-message").fadeIn(100)})},removeField:function(i){var a=t;i.preventDefault();var o=e(i.currentTarget).parents(".active-drop");e(i.currentTarget).parents(".gv-fields").fadeOut("normal",function(){e(this).remove(),a.toggleDropMessage()})},openFieldSettings:function(i){i.preventDefault();var a,o=t;a=e(i.currentTarget).is(".gv-fields")?e(i.currentTarget):e(i.currentTarget).parents(".gv-fields"),o.updateVisibilitySettings(i,!0),e("body").on("change",".gv-fields input:checkbox",o.updateVisibilitySettings);var l=[{text:gvGlobals.label_close,click:function(){e(this).dialog("close")}}];o.showDialog(a.find(".gv-dialog-options"),l)},updateVisibilitySettings:function(i,a){var o=t;a=a||!1,$parent=e(i.currentTarget).is(".gv-fields")?e(i.currentTarget):e(i.currentTarget).parents(".gv-fields"),o.toggleVisibility(e("input:checkbox[name*=show_label]",$parent),e("[name*=custom_label]",$parent),a),e("input:checkbox",$parent).attr("disabled",null),e("input:checkbox[name*=show_as_link]",$parent).is(":checked")&&e("input:checkbox[name*=link_to_]",$parent).attr("disabled",!0),e("input:checkbox[name*=link_to_]:checked",$parent).length>0&&e("input:checkbox[name*=show_as_link]",$parent).attr("disabled",!0),o.toggleVisibility(e("input:checkbox[name*=only_loggedin]",$parent),e("[name*=only_loggedin_cap]",$parent),a)},toggleVisibility:function(e,t,i){var a=i?0:"fast";e.is(":checked")?t.parents("li").fadeIn(a):t.parents("li").fadeOut(a)},createPresetForm:function(){var i=t,a=e("#gravityview_directory_template").val();if(!i.startFreshStatus||""===a)return!0;var o={action:"gv_set_preset_form",template_id:a,nonce:gvGlobals.nonce};return e.post(ajaxurl,o,function(t){"false"!=t?(i.startFreshStatus=!1,i.gvSelectForm.find("option:selected").removeAttr("selected"),i.gvSelectForm.append(t),e("#publish").trigger("click")):e("#post").before('<div id="message" class="error below-h2"><p>'+gvGlobals.label_publisherror+"</p></div>")}),!1}};e(document).ready(function(){e("#title-prompt-text").text(gvGlobals.label_viewname),t.init(),e(".gv-datepicker").datepicker({dateFormat:"yy-mm-dd",constrainInput:!1});var i="gv-active-tab-"+e("#post_ID").val(),a=e.cookie(i);"undefined"===a&&(a=0),e("#tabs").tabs({active:a,activate:function(t,a){e.cookie(i,a.newTab.index(),{path:gvGlobals.cookiepath})}}),e("#gravityview_template_settings .form-table tr:even").addClass("alternate")})}(jQuery);