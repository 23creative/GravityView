/**
 * Custom js script at Add New / Edit Views screen
 *
 * @package   GravityView
 * @license   GPL2+
 * @author    Katz Web Services, Inc.
 * @link      http://gravityview.co
 * @copyright Copyright 2014, Katz Web Services, Inc.
 *
 * @since 1.0.0
 */
!function(e){var t={startFreshStatus:!1,init:function(){var i=t;i.gvStartFreshButton=e('a[href="#gv_start_fresh"]'),i.gvSelectForm=e("#gravityview_form_id"),i.currentFormId=i.gvSelectForm.val(),""===i.currentFormId?i.hideView():e("#gravityview_directory_template").val().length>0?(e("#gravityview_select_template").slideUp(150),i.showViewConfig()):(i.templateFilter("custom"),i.showTemplates()),i.gvStartFreshButton.click(i.startFresh),i.gvSelectForm.change(i.formChange),e('a[href="#gv_switch_view"]').click(i.switchView),e('a[href="#gv_select_template"]').click(i.selectTemplate),e(".gv-view-types-hover").click(i.selectTemplateHover),e('a[href="#gv_preview_template"]').click(i.previewTemplate),e(document).on("mouseup keyup",function(t){var i=!1;"keyup"===t.type&&27==t.keyCode&&(i=!0),"mouseup"===t.type&&(!e(t.target).is(".ui-tooltip")&&!e(t.target).parents(".ui-tooltip").length>0||e(t.target).parents(".close").length>0)&&(i=!0),i&&e("a.gv-add-field[data-tooltip='active']").tooltip("close")}),e("body").on("click",".ui-tooltip-content .gv-fields",i.addField),e("body").on("click","span.gv-field-controls a[href='#remove']",i.removeField),e("body").on("click","span.gv-field-controls a[href='#settings']",i.openFieldSettings),e("body").on("dblclick",".gv-fields",function(e){i.openFieldSettings(e)}),e(document).on("click","#publish",i.createPresetForm)},hideView:function(){var i=t;i.currentFormId="",e("#gravityview_view_config, #gravityview_select_template").hide()},showTemplates:function(){e("#gravityview_select_template").slideDown(150)},startFresh:function(e){e.preventDefault();var i=t;i.startFreshStatus=!0,""!==i.currentFormId?i.showDialog("#gravityview_form_id_dialog"):i.startFreshContinue()},startFreshContinue:function(){var i=t;e("#gravityview_form_id_start_fresh").val("1"),i.templateFilter("preset"),i.showTemplates(),e("#gravityview_view_config").slideUp(150)},formChange:function(){var i=t;i.startFreshStatus=!1,""!==i.currentFormId&&i.currentFormId!==e(this).val()?i.showDialog("#gravityview_form_id_dialog"):i.formChangeContinue()},formChangeContinue:function(){var e=t;""===e.gvSelectForm.val()?e.hideView():(e.templateFilter("custom"),e.showTemplates(),e.getAvailableFields(),e.getSortableFields())},showDialog:function(i,a){var o=t,r=e(i),l=[{text:gvGlobals.label_cancel,click:function(){r.is("#gravityview_form_id_dialog")?(o.startFreshStatus=!1,o.gvSelectForm.val(o.currentFormId)):r.is("#gravityview_switch_template_dialog")&&e("#gravityview_select_template").slideUp(150),r.dialog("close")}},{text:gvGlobals.label_continue,click:function(){r.is("#gravityview_form_id_dialog")?o.startFreshStatus?o.startFreshContinue():o.formChangeContinue():r.is("#gravityview_switch_template_dialog")&&o.selectTemplateContinue(),r.dialog("close")}}];a=a||l,r.dialog({dialogClass:"wp-dialog",appendTo:r.parent(),width:function(){return e(window).width()>550?550:e(window).width()-10},open:function(){e('<div class="gv-overlay" />').prependTo("#wpwrap")},close:function(){e("#wpwrap > .gv-overlay").fadeOut("fast",function(){e(this).remove()})},closeOnEscape:!0,buttons:a})},getSortableFields:function(i,a){var o=t,r={action:"gv_sortable_fields_form",nonce:gvGlobals.nonce};void 0!==i&&"preset"===i?r.template_id=a:r.form_id=o.gvSelectForm.val(),e.post(ajaxurl,r,function(t){"false"!==t&&(e("#gravityview_sort_field").empty(),e("#gravityview_sort_field").append(t))})},switchView:function(e){e.preventDefault();var i=t;i.templateFilter("custom"),i.showTemplates()},templateFilter:function(t){e(".gv-view-types-module").each(function(){e(this).attr("data-filter")===t?e(this).parent().show():e(this).parent().hide()})},selectTemplate:function(i){var a=t;i.preventDefault(),i.stopImmediatePropagation(),a.wantedTemplate=e(this);var o=e("#gravityview_directory_template").val(),r=a.wantedTemplate.attr("data-templateid");""===o?a.selectTemplateContinue():o!=r&&a.showDialog("#gravityview_switch_template_dialog")},selectTemplateContinue:function(){var i=t,a=i.wantedTemplate.attr("data-templateid");e("#gravityview_directory_template").val(a);var o=i.wantedTemplate.parents(".gv-view-types-module");o.parents(".gv-grid").find(".gv-view-types-module").removeClass("gv-selected"),o.addClass("gv-selected"),i.startFreshStatus?(i.getAvailableFields("preset",a),i.getPresetFields(a),i.getSortableFields("preset",a)):(i.updateActiveAreas(a),e("#gravityview_select_template").slideUp(150))},selectTemplateHover:function(t){t.preventDefault(),t.stopImmediatePropagation(),e(this).find('a[href="#gv_select_template"]').trigger("click")},previewTemplate:function(t){t.preventDefault(),t.stopImmediatePropagation();var i=e(event.currentTarget).parents(".gv-view-types-module");i.find(".gv-template-preview").dialog({dialogClass:"wp-dialog",appendTo:e("#gravityview_select_template"),width:550,open:function(){e('<div class="gv-overlay" />').prependTo("#wpwrap")},close:function(){e("#wpwrap > .gv-overlay").fadeOut("fast",function(){e(this).remove()})},closeOnEscape:!0,buttons:[{text:gvGlobals.label_close,click:function(){e(this).dialog("close")}}],close:function(){e(this).dialog("option","appendTo",i)}})},updateActiveAreas:function(i){var a=t;e("#directory-active-fields, #single-active-fields").children().remove();var o={action:"gv_get_active_areas",template_id:i,nonce:gvGlobals.nonce};e.post(ajaxurl,o,function(t){if(t){var i=e.parseJSON(t);e("#directory-header-widgets").html(i.header),e("#directory-footer-widgets").html(i.footer),e("#directory-active-fields").append(i.directory),e("#single-active-fields").append(i.single),a.showViewConfig()}})},getPresetFields:function(i){var a=t;e("#directory-active-fields, #single-active-fields").children().remove();var o={action:"gv_get_preset_fields",template_id:i,nonce:gvGlobals.nonce};e.post(ajaxurl,o,function(t){if(t){var i=e.parseJSON(t);e("#directory-header-widgets").html(i.header),e("#directory-footer-widgets").html(i.footer),e("#directory-active-fields").append(i.directory),e("#single-active-fields").append(i.single),a.showViewConfig()}})},showViewConfig:function(){var i=t;e("#gravityview_view_config").slideDown(150),i.toggleDropMessage(),i.init_droppables(),i.init_tooltips()},init_tooltips:function(){var i=t;e(".gv-add-field").tooltip({content:function(){var t=e(this).attr("data-objecttype");return"field"===t?e("#directory-available-fields").html():"widget"===t?e("#directory-available-widgets").html():void 0},close:function(t,i){e(this).attr("data-tooltip","")},open:function(t,i){e(this).attr("data-tooltip","active").attr("data-tooltip-id",e(this).attr("aria-describedby"))},closeOnEscape:!0,disabled:!0,position:{my:"center bottom",at:"center top-12"},tooltipClass:"top"}).on("mouseout focusout",function(e){e.stopImmediatePropagation()}).click(function(t){t.preventDefault(),t.stopImmediatePropagation(),e(this).tooltip("open"),e(this).attr("title","")})},getAvailableFields:function(i,a){var o=t;e("#directory-available-fields, #single-available-fields").find(".gv-fields").remove(),e("#directory-active-fields, #single-active-fields").find(".gv-fields").remove(),o.toggleDropMessage();var r={action:"gv_available_fields",nonce:gvGlobals.nonce};void 0!==i&&"preset"===i?r.templateid=a:r.formid=o.gvSelectForm.val(),e.post(ajaxurl,r,function(t){t&&(e("#directory-available-fields").append(t),e("#single-available-fields").append(t))})},addField:function(i){i.preventDefault();var a=t,o=e(this).clone().hide(),r=e(this).parents(".ui-tooltip").attr("id"),l=e("#gravityview_directory_template").val(),n=e(this).parents(".ui-tooltip").attr("id"),s=e('a.gv-add-field[data-tooltip-id="'+n+'"]'),d={action:"gv_field_options",template:l,area:s.attr("data-areaid"),context:s.attr("data-context"),field_id:o.attr("data-fieldid"),field_label:o.find("h5").text(),field_type:s.attr("data-objecttype"),input_type:s.attr("data-objecttype"),nonce:gvGlobals.nonce};e.post(ajaxurl,d,function(e){e&&o.append(e)}),e('a[data-tooltip-id="'+r+'"]').parents(".gv-droppable-area").find(".active-drop").append(o).end().attr("data-tooltip-id",""),o.fadeIn(),o.siblings(".gv-fields").length>0&&(tooltipOffset=e("#"+n).offset(),e("#"+n).offset({top:tooltipOffset.top+o.outerHeight()+5})),a.toggleDropMessage()},init_droppables:function(){var i=t;e("#directory-fields, #single-fields").find(".active-drop-widget").sortable({placeholder:"fields-placeholder",items:"> .gv-fields",distance:2,connectWith:".active-drop-widget",receive:function(t,a){var o=a.sender.attr("data-areaid"),r=e(this).attr("data-areaid");a.item.find('[name^="widgets['+o+']"]').each(function(){var t=e(this).attr("name");e(this).attr("name",t.replace(o,r))}),i.toggleDropMessage()}}),e("#directory-fields, #single-fields").find(".active-drop-field").sortable({placeholder:"fields-placeholder",items:"> .gv-fields",distance:2,connectWith:".active-drop-field",receive:function(t,a){if(a.item.find(".gv-dialog-options").length>0){var o=a.sender.attr("data-areaid"),r=e(this).attr("data-areaid");a.item.find('[name^="fields['+o+']"]').each(function(){var t=e(this).attr("name");e(this).attr("name",t.replace(o,r))})}i.toggleDropMessage()}})},toggleDropMessage:function(){e(".active-drop").each(function(){e(this).find(".gv-fields").length>0?e(this).find(".drop-message").hide():e(this).find(".drop-message").fadeIn(100)})},removeField:function(i){var a=t;i.preventDefault();var o=e(i.currentTarget).parents(".active-drop");e(i.currentTarget).parents(".gv-fields").fadeOut("normal",function(){e(this).remove(),a.toggleDropMessage()})},openFieldSettings:function(i){i.preventDefault();var a,o=t;a=e(i.currentTarget).is(".gv-fields")?e(i.currentTarget):e(i.currentTarget).parents(".gv-fields"),e("body").on("change",'select[id*="loggedin_cap"]',o.toggleVisibilityCheckbox);var r=[{text:gvGlobals.label_close,click:function(){e(this).dialog("close")}}];o.showDialog(a.find(".gv-dialog-options"),r)},toggleVisibilityCheckbox:function(t){var i=e(t.currentTarget).parent().find("input:checkbox[name*=only_loggedin]");"read"!==e(t.currentTarget).val()?i.attr("checked","checked"):i.attr("checked",null)},createPresetForm:function(){var i=t,a=e("#gravityview_directory_template").val();if(!i.startFreshStatus||""===a)return!0;var o={action:"gv_set_preset_form",template_id:a,nonce:gvGlobals.nonce};return e.post(ajaxurl,o,function(t){"false"!=t?(i.startFreshStatus=!1,e("#gravityview_form_id_start_fresh").val("0"),i.gvSelectForm.find("option:selected").removeAttr("selected"),i.gvSelectForm.append(t),e("#publish").trigger("click")):e("#post").before('<div id="message" class="error below-h2"><p>'+gvGlobals.label_publisherror+"</p></div>")}),!1}};e(document).ready(function(){e("#title-prompt-text").text(gvGlobals.label_viewname),t.init(),e(".gv-datepicker").datepicker({dateFormat:"yy-mm-dd"});var i="gv-active-tab-"+e("#post_ID").val(),a=e.cookie(i);"undefined"===a&&(a=0),e("#tabs").tabs({active:a,activate:function(t,a){e.cookie(i,a.newTab.index(),{path:gvGlobals.cookiepath})}}),e("#gravityview_template_settings .form-table tr:even").addClass("alternate")})}(jQuery);